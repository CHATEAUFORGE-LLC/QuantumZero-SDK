services:
  # Tails Server - For revocation registry tails files
  tails-server:
    image: ghcr.io/bcgov/tails-server:latest
    container_name: qz-tails-server
    ports:
      - "6543:6543"
    command: >
      tails-server
      --host 0.0.0.0
      --port 6543
      --storage-path /tmp/tails-files
    volumes:
      - tails_files:/tmp/tails-files
    networks:
      - quantumzero-network
      - indy
    restart: unless-stopped

  # ACA-Py agent for the issuer - handles ledger operations and DIDComm
  issuer-acapy:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.2-lts
    container_name: qz-issuer-acapy
    command: >
      start
      --inbound-transport http 0.0.0.0 8000
      --outbound-transport http
      --admin 0.0.0.0 11000
      --admin-insecure-mode
      --label "QuantumZero-Issuer-Agent"
      --endpoint http://issuer-acapy:8000
      --auto-provision
      --wallet-type askar
      --wallet-name qz-issuer
      --wallet-key qz-issuer-secure-key-change-in-production
      --wallet-allow-insecure-seed
      --genesis-url http://ledger-browser:8000/genesis
      --auto-accept-invites
      --auto-accept-requests
      --auto-respond-credential-proposal
      --auto-respond-credential-offer
      --auto-respond-credential-request
      --auto-store-credential
      --auto-respond-presentation-proposal
      --auto-respond-presentation-request
      --auto-verify-presentation
      --public-invites
      --tails-server-base-url http://tails-server:6543
      --endorser-protocol-role author
      --endorser-public-did Cbkb3vmwitw4DoxkitzxdJ
      --endorser-alias QZ-Endorser
      --auto-request-endorsement
      --auto-write-transactions
      --auto-create-revocation-transactions
      --log-level info
    ports:
      - "11001:11000"
      - "8002:8000"
    volumes:
      - issuer_acapy_data:/home/aries/.acapy_agent
    networks:
      - quantumzero-network
      - indy
    restart: unless-stopped
    depends_on:
      tails-server:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11000/status/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Issuer application - web UI for creating schemas, cred-defs, and managing credentials
  issuer-app:
    build:
      context: .
      dockerfile: issuer_app/Dockerfile
    container_name: qz-issuer-app
    environment:
      ISSUANCE_API_URL: http://qz-issuance-api:8081
      LEDGER_URL: http://ledger-browser:8000
      ACAPY_ADMIN_URL: http://issuer-acapy:11000
      TRUSTEE_ACAPY_ADMIN_URL: http://acapy-endorser:11000
      QZ_PUBLIC_AGENT_URL: ${QZ_PUBLIC_AGENT_URL:-}
      QZ_MOBILE_APP_SCHEME: ${QZ_MOBILE_APP_SCHEME:-quantumzero}
      BIND_ADDRESS: 0.0.0.0:8090
      RUST_LOG: info
    ports:
      - "3030:8090"
    networks:
      - quantumzero-network
      - indy
    depends_on:
      issuer-acapy:
        condition: service_healthy
    restart: unless-stopped

  # ACA-Py agent for the verifier - handles proof verification via DIDComm
  verifier-acapy:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.2-lts
    container_name: qz-verifier-acapy
    command: >
      start
      --inbound-transport http 0.0.0.0 8000
      --outbound-transport http
      --admin 0.0.0.0 11000
      --admin-insecure-mode
      --label "QuantumZero-Verifier-Agent"
      --endpoint http://verifier-acapy:8000
      --auto-provision
      --wallet-type askar
      --wallet-name qz-verifier
      --wallet-key qz-verifier-secure-key-change-in-production
      --genesis-url http://ledger-browser:8000/genesis
      --auto-accept-invites
      --auto-accept-requests
      --auto-respond-presentation-proposal
      --auto-respond-presentation-request
      --auto-verify-presentation
      --public-invites
      --webhook-url http://verifier-app:8091/webhooks
      --log-level info
    ports:
      - "11002:11000"
      - "8003:8000"
    volumes:
      - verifier_acapy_data:/home/aries/.acapy_agent
    networks:
      - quantumzero-network
      - indy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11000/status/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Verifier application - web UI for requesting and verifying proofs
  verifier-app:
    build:
      context: .
      dockerfile: verifier_app/Dockerfile
    container_name: qz-verifier-app
    environment:
      ISSUANCE_API_URL: http://qz-issuance-api:8081
      LEDGER_URL: http://ledger-browser:8000
      ACAPY_ADMIN_URL: http://verifier-acapy:11000
      QZ_PUBLIC_VERIFIER_URL: ${QZ_PUBLIC_VERIFIER_URL:-}
      QZ_MOBILE_APP_SCHEME: ${QZ_MOBILE_APP_SCHEME:-quantumzero}
      BIND_ADDRESS: 0.0.0.0:8091
      RUST_LOG: info
    ports:
      - "3031:8091"
    networks:
      - quantumzero-network
      - indy
    depends_on:
      verifier-acapy:
        condition: service_healthy
    restart: unless-stopped

networks:
  quantumzero-network:
    external: true
    name: quantumzero-network
  indy:
    external: true
    name: indy

volumes:
  issuer_acapy_data:
  verifier_acapy_data:
  tails_files:
